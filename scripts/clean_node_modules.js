#!/usr/bin/env node

const fs = require('fs')
const path = require('path')
const findit = require('findit')
const finder = findit(path.resolve(process.cwd(), 'node_modules'))
const prettify = obj => JSON.stringify(obj, null, 2)
const rethrow = err => {
  if (err) throw err
}

const stripFields = [
  'readme',
  'readmeFilename'
]


const clean = file => {
  const pkgJson = require(file)
  let cleaned
  let bytes = 0
  for (const field of stripFields) {
    if (!(field in pkgJson)) continue

    cleaned = true
    const valLength = Buffer.byteLength(String(pkgJson[field]))
    console.log(`deleting field ${field} from ${file}, length: ${valLength}`)
    bytes += valLength
    delete pkgJson[field]
  }

  fs.writeFile(file, prettify(pkgJson), rethrow)
  return bytes
}

let bytesCleaned = 0

finder.on('file', (file, stat) => {
  if (!/package\.json$/.test(file)) return

  bytesCleaned += clean(file)
})

finder.on('end', () => {
  console.log(`removed ${bytesCleaned} bytes of garbage`)
})
